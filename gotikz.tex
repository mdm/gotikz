%\catcode`@=11%

\def\gotikz@empty{\gotikz@empty}
\def\gotikz@marks@none{0}
\def\gotikz@marks@triangle{1}
\def\gotikz@marks@square{2}
\def\gotikz@marks@circle{3}

\gdef\gotikz@currentdiagram@size{19}% TODO: doesn't need to be global
\gdef\gotikz@currentdiagram@blackstones{\gotikz@empty}
\gdef\gotikz@currentdiagram@whitestones{\gotikz@empty}
\gdef\gotikz@currentdiagram@numbers@coordinates{\gotikz@empty}
\gdef\gotikz@currentdiagram@numbers@values{\gotikz@empty}
\gdef\gotikz@currentdiagram@marks@coordinates{\gotikz@empty}
\gdef\gotikz@currentdiagram@marks@values{\gotikz@empty}
\gdef\gotikz@currentdiagram@labels@coordinates{\gotikz@empty}
\gdef\gotikz@currentdiagram@labels@values{\gotikz@empty}

\def\gotikz@coordinates@letterinrange #1(#2-#3)\iftrue{%
    \ifnum 1=\numexpr 0%
        \ifnum`#1<\numexpr`#3+1\relax
            \ifnum`#1>\numexpr`#2-1\relax 1\fi\fi \relax
}

\def\gotikz@coordinates@convertletter#1{%
    \gotikz@coordinates@letterinrange#1(a-z)\iftrue \the\numexpr`#1-`a+1\relax-%
    \else \gotikz@coordinates@letterinrange#1(A-Z)\iftrue \the\numexpr`#1-`A+27\relax-%
        \else #1%
    \fi\fi
}


\def\gotikz@coordinates@internalrepr#1-#2/{%
    \the\numexpr#1-1\relax/\the\numexpr#2-1\relax%
}

\def\gotikz@coordinates@equal#1/#2/#3/#4\iftrue{%
    \ifnum 1=\numexpr 0%
        \ifnum#1=#3
            \ifnum#2=#4 1\fi\fi \relax
}

\def\gotikz@coordinates@contains#1#2\iftrue{%
    \gdef\gotikz@coordinates@contains@found{0}

    \ifx#1\gotikz@empty\else
    \foreach \coordinate in #1 {%
        \expandafter\gotikz@coordinates@equal\coordinate/#2\iftrue%
            \gdef\gotikz@coordinates@contains@found{1}% TODO: smuggle this value out instead of using a global
            \breakforeach
        \fi
    }
    \fi

    \ifnum 1=\numexpr\gotikz@coordinates@contains@found\relax
}

\def\mycontains#1#2{\gotikz@coordinates@contains{#1}{#2}}
\def\mycontainstwo{\gotikz@coordinates@contains{\gotikz@currentdiagram@blackstones}{10/9}}

\def\gotikz@utils@addtolist#1#2{%
    \xdef#1{%
        \ifx#1\gotikz@empty
            #2%
        \else
            #1,#2%
        \fi
    }%
}

\def\gotikz@coordinates@addtolist#1#2{%
    \foreach \stone in {#2} {%
        \edef\stone{\expandafter\gotikz@coordinates@convertletter\stone}%
        \edef\stone{\expandafter\gotikz@coordinates@internalrepr\stone/}%
        \gotikz@utils@addtolist#1\stone
    }%
}

\def\gotikz@utils@ifnextchar#1#2#3{%
    \let\gotikz@utils@ifnextchar@char=#1%
    \def\gotikz@utils@ifnextchar@yesoption{#2}%
    \def\gotikz@utils@ifnextchar@nooption{#3}%
    \futurelet\gotikz@utils@ifnextchar@nexttoken\gotikz@utils@ifnextchar@choose
}

\def\gotikz@utils@ifnextchar@choose{%
    \ifx\gotikz@utils@ifnextchar@nexttoken\gotikz@utils@ifnextchar@char%
        \let\gotikz@utils@ifnextchar@choice\gotikz@utils@ifnextchar@yesoption%
    \else%  
        \let\gotikz@utils@ifnextchar@choice\gotikz@utils@ifnextchar@nooption%
    \fi%
    \gotikz@utils@ifnextchar@choice%
}

\def\black{%
    \gotikz@utils@ifnextchar[{\gotikz@addstones@withoptions\gotikz@currentdiagram@blackstones}{\gotikz@addstones@nooptions\gotikz@currentdiagram@blackstones}%
}

\def\white{%
    \gotikz@utils@ifnextchar[{\gotikz@addstones@withoptions\gotikz@currentdiagram@whitestones}{\gotikz@addstones@nooptions\gotikz@currentdiagram@whitestones}%
}

\pgfkeys{%
    /gotikz/stone/mark/.is choice,
    /gotikz/stone/mark/triangle/.style={/gotikz/mark/type=triangle},
    /gotikz/stone/mark/square/.style={/gotikz/mark/type=square},
    /gotikz/stone/mark/circle/.style={/gotikz/mark/type=circle},
}

\def\gotikz@addstones@withoptions#1[#2]#3{%
    \pgfkeys{/gotikz/stone/.cd,#2}{%
        \gotikz@coordinates@addtolist#1{#3}
        \ifx\gotikz@marks@selected\gotikz@marks@none\else
            \gotikz@coordinates@addtolist\gotikz@currentdiagram@marks@coordinates{#3}
            \foreach \stone in {#3} {%
                \gotikz@utils@addtolist\gotikz@currentdiagram@marks@values\gotikz@marks@selected
            }
        \fi            
    }
}

\def\gotikz@addstones@nooptions#1#2{%
    \gotikz@addstones@withoptions#1[]{#2}
}

\pgfkeys{%
    /gotikz/mark/@selected/.initial=\gotikz@marks@none,
    /gotikz/mark/@selected/.get=\gotikz@marks@selected,
    /gotikz/mark/@selected/.store in=\gotikz@marks@selected,
    /gotikz/mark/type/.is choice,
    /gotikz/mark/type/triangle/.style={/gotikz/mark/@selected=\gotikz@marks@triangle},
    /gotikz/mark/type/square/.style={/gotikz/mark/@selected=\gotikz@marks@square},
    /gotikz/mark/type/circle/.style={/gotikz/mark/@selected=\gotikz@marks@circle},
}

\def\gotikz@addmarks@withoptions[#1]#2{%
    \pgfkeys{/gotikz/mark/.cd,type=triangle,#1}{%
        \gotikz@coordinates@addtolist\gotikz@currentdiagram@marks@coordinates{#2}
        \foreach \ignore in {#2}{%
            \gotikz@utils@addtolist\gotikz@currentdiagram@marks@values\gotikz@marks@selected
        }
    }
}

\def\gotikz@addmarks@nooptions#1{%
    \gotikz@addmarks@withoptions[]{#1}
}

\def\addmarks{%
    \gotikz@utils@ifnextchar[{\gotikz@addmarks@withoptions}{\gotikz@addmarks@nooptions}%
}

\def\showdiagram{%
    \tikzpicture[scale = 8cm / \gotikz@currentdiagram@size / 1cm]
    % \tikzpicture
        % board
        % \clip(-0.1, -0.1) rectangle (4.6, 4.6);
        \draw (0, 0) grid [very thin, step = 1] (\gotikz@currentdiagram@size - 1, \gotikz@currentdiagram@size - 1);
        \draw [very thick] (0, 0) rectangle (\gotikz@currentdiagram@size - 1, \gotikz@currentdiagram@size - 1);

        % hoshi
        \filldraw [black] (3, 3) circle [radius = 3pt];
        \filldraw [black] (3, 9) circle [radius = 3pt];
        \filldraw [black] (3, 15) circle [radius = 3pt];
        \filldraw [black] (9, 3) circle [radius = 3pt];
        \filldraw [black] (9, 9) circle [radius = 3pt];
        \filldraw [black] (9, 15) circle [radius = 3pt];
        \filldraw [black] (15, 3) circle [radius = 3pt];
        \filldraw [black] (15, 9) circle [radius = 3pt];
        \filldraw [black] (15, 15) circle [radius = 3pt];

        % black stones
        \ifx\gotikz@currentdiagram@blackstones\gotikz@empty\else
            \foreach \x/\y in \gotikz@currentdiagram@blackstones {
                % \filldraw [black] (\x, \y) circle [radius = 0.5cm - 0.5pt];
                \node [fill = black, draw = black, circle, minimum size = 1cm - 1pt, scale = 8cm / \gotikz@currentdiagram@size / 1cm] at (\x, \y) {};
                % \node [white, xscale = {min(1,height("0")/width("252"))}] at (\x, \y) {252};
            % \draw [white] (\x,\y)+(90:0.5cm - 0.05cm) -- +(210:0.5cm - 0.05cm) -- +(330:0.5cm - 0.05cm) -- cycle;
                % \node[regular polygon, regular polygon sides=3, minimum size = 0.9cm, scale = 8cm / \gotikz@currentdiagram@size / 1cm, draw = white] at (\x, \y) {};
            }
        \fi

        % white stones
        \ifx\gotikz@currentdiagram@whitestones\gotikz@empty\else
            \foreach \x/\y in \gotikz@currentdiagram@whitestones {
                \gotikz@coordinates@equal 0/0/\x/\y\iftrue
                    \node [fill = white, draw = red, circle, minimum size = 1cm - 1pt, scale = 8cm / \gotikz@currentdiagram@size / 1cm] at (\x, \y) {};
                \else
                    \node [fill = white, draw = black, circle, minimum size = 1cm - 1pt, scale = 8cm / \gotikz@currentdiagram@size / 1cm] at (\x, \y) {};
                    % \node [black, xscale = {min(1,height("0")/width("252"))}] at (\x, \y) {252};
                \fi
            }
        \fi

        % marks
        \ifx\gotikz@currentdiagram@marks@coordinates\gotikz@empty\else
            \foreach \x/\y [count=\c,evaluate=\c as \type using {{\gotikz@currentdiagram@marks@values}[\c-1]}] in \gotikz@currentdiagram@marks@coordinates {%
                \gotikz@coordinates@contains{\gotikz@currentdiagram@blackstones}{\x/\y}\iftrue
                    \ifx\type\gotikz@marks@triangle
                        \draw [fill = black, draw = white] (\x,\y)+(90:0.5cm - 0.1cm) -- +(210:0.5cm - 0.1cm) -- +(330:0.5cm - 0.1cm) -- cycle;
                    \fi
                    \ifx\type\gotikz@marks@square
                        \draw [fill = black, draw = white] (\x,\y)+(45:0.5cm - 0.1cm) -- +(135:0.5cm - 0.1cm) -- +(225:0.5cm - 0.1cm) -- +(315:0.5cm - 0.1cm) -- cycle;
                    \fi
                    \ifx\type\gotikz@marks@circle
                        % \draw [fill = black, draw = white] (\x,\y) circle (cos(45) * (0.5cm - 0.1cm));
                        \draw [fill = black, draw = white] (\x,\y) circle (0.2828cm);
                    \fi
                \else
                    \ifx\type\gotikz@marks@triangle
                        \draw [fill = white, draw = black] (\x,\y)+(90:0.5cm - 0.1cm) -- +(210:0.5cm - 0.1cm) -- +(330:0.5cm - 0.1cm) -- cycle;
                    \fi
                    \ifx\type\gotikz@marks@square
                        \draw [fill = white, draw = black] (\x,\y)+(45:0.5cm - 0.1cm) -- +(135:0.5cm - 0.1cm) -- +(225:0.5cm - 0.1cm) -- +(315:0.5cm - 0.1cm) -- cycle;
                    \fi
                    \ifx\type\gotikz@marks@circle
                        \draw [fill = white, draw = black] (\x,\y) circle (0.2828cm);
                    \fi
                \fi
            }
        \fi
    \endtikzpicture
}

%\catcode`@=12%
